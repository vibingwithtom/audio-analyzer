<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper Transcription Prototype</title>
    <script src="https://unpkg.com/@xenova/transformers@2.6.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="file"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="file"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 150px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.95rem;
        }

        .file-info {
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .status {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status.warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #e65100;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: #999;
        }

        .score-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 8px;
        }

        .score-pass {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .score-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .score-fail {
            background: #ffebee;
            color: #c62828;
        }

        .results-section {
            margin-top: 20px;
        }

        .text-box {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .text-box.empty {
            color: #999;
            font-style: italic;
        }

        .model-status {
            padding: 12px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .comparison {
                grid-template-columns: 1fr;
            }

            .metrics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéôÔ∏è Whisper Transcription Prototype</h1>
            <p>Test local Whisper transcription performance and quality</p>
        </header>

        <div class="content">
            <!-- Input Section -->
            <div class="card">
                <h2>Audio Input</h2>
                <div class="model-status" id="modelStatus">
                    <strong>Model Status:</strong> Loading transformers.js...
                    <div class="progress-bar">
                        <div class="progress-fill" id="modelProgress"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="audioInput">Select Audio File</label>
                    <input type="file" id="audioInput" accept="audio/*" />
                    <div class="file-info" id="fileInfo">No file selected</div>
                </div>

                <button class="btn-primary" id="transcribeBtn" onclick="transcribeAudio()" disabled>
                    Transcribe Audio
                </button>
                <button class="btn-secondary" onclick="clearResults()">Clear Results</button>

                <div id="statusArea"></div>
            </div>

            <!-- Reference Script Section -->
            <div class="card">
                <h2>Reference Script</h2>
                <div class="form-group">
                    <label for="scriptInput">Paste Reference Script</label>
                    <textarea id="scriptInput" placeholder="Paste the script that should match the audio..."></textarea>
                </div>
                <button class="btn-secondary" onclick="loadSampleScript()">Load Sample</button>
            </div>

            <!-- Results Section -->
            <div class="card full-width" id="resultsCard" style="display: none;">
                <h2>Results</h2>

                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">String Similarity</div>
                        <div class="metric-value" id="stringSimilarity">-</div>
                        <div class="metric-unit">%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Word Accuracy</div>
                        <div class="metric-value" id="wordAccuracy">-</div>
                        <div class="metric-unit">%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Processing Time</div>
                        <div class="metric-value" id="processingTime">-</div>
                        <div class="metric-unit">seconds</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Audio Duration</div>
                        <div class="metric-value" id="audioDuration">-</div>
                        <div class="metric-unit">seconds</div>
                    </div>
                </div>

                <div id="scoreDisplay"></div>

                <div class="comparison">
                    <div>
                        <h3 style="margin-bottom: 12px; color: #333;">Transcribed Text</h3>
                        <div class="text-box" id="transcribedText"></div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 12px; color: #333;">Reference Script</h3>
                        <div class="text-box" id="referenceText"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let model = null;

        // Initialize Whisper model
        async function initializeModel() {
            try {
                // Wait for Transformers library to load
                if (!window.transformers || !window.transformers.pipeline) {
                    throw new Error('Transformers.js library failed to load. Please refresh the page and try again.');
                }

                const statusEl = document.getElementById('modelStatus');
                const progressEl = document.getElementById('modelProgress');

                statusEl.innerHTML = '<strong>Model Status:</strong> Loading Whisper model...<div class="progress-bar"><div class="progress-fill" id="modelProgress"></div></div>';

                const pipe = await window.transformers.pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny.en', {
                    quantized: true, // Use quantized version for speed
                    progress_callback: (progress) => {
                        const percent = Math.round(progress.progress * 100);
                        progressEl.style.width = percent + '%';
                        statusEl.innerHTML = `<strong>Model Status:</strong> Loading Whisper model (${percent}%)...<div class="progress-bar"><div class="progress-fill" id="modelProgress" style="width: ${percent}%;"></div></div>`;
                    }
                });

                statusEl.innerHTML = '<span style="color: #2e7d32;"><strong>‚úì Model Ready:</strong> Whisper-tiny loaded successfully (quantized)</span>';
                document.getElementById('transcribeBtn').disabled = false;

                return pipe;
            } catch (error) {
                const statusEl = document.getElementById('modelStatus');
                statusEl.innerHTML = `<span style="color: #c62828;"><strong>‚úó Error:</strong> ${error.message}</span>`;
                console.error('Model initialization error:', error);
            }
        }

        // Initialize model on page load
        window.addEventListener('load', async () => {
            // Wait for library to load with timeout
            let attempts = 0;
            while (!window.transformers && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }

            if (!window.transformers) {
                document.getElementById('modelStatus').innerHTML =
                    '<span style="color: #c62828;"><strong>‚úó Error:</strong> Failed to load Transformers.js library from CDN. Please check your internet connection and refresh the page.</span>';
                return;
            }

            model = await initializeModel();
        });

        // Handle file selection
        document.getElementById('audioInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.textContent = `üìÑ ${file.name} (${sizeMB} MB, ${file.type})`;
            }
        });

        // String similarity using Levenshtein distance
        function stringSimilarity(a, b) {
            const longer = a.length > b.length ? a : b;
            const shorter = a.length > b.length ? b : a;
            if (longer.length === 0) return 100;

            const editDistance = getEditDistance(longer, shorter);
            return ((longer.length - editDistance) / longer.length) * 100;
        }

        // Calculate Levenshtein distance
        function getEditDistance(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        // Calculate word accuracy
        function calculateWordAccuracy(transcribed, reference) {
            const refWords = reference.toLowerCase().split(/\s+/).filter(w => w);
            const transWords = transcribed.toLowerCase().split(/\s+/).filter(w => w);

            if (refWords.length === 0) return 0;

            let matches = 0;
            const used = new Set();

            for (const refWord of refWords) {
                for (let i = 0; i < transWords.length; i++) {
                    if (!used.has(i) && transWords[i] === refWord) {
                        matches++;
                        used.add(i);
                        break;
                    }
                }
            }

            return (matches / refWords.length) * 100;
        }

        // Transcribe audio
        async function transcribeAudio() {
            const audioInput = document.getElementById('audioInput');
            const scriptInput = document.getElementById('scriptInput');

            if (!model) {
                showStatus('Model is still loading. Please wait...', 'warning');
                return;
            }

            if (!audioInput.files[0]) {
                showStatus('Please select an audio file', 'error');
                return;
            }

            const file = audioInput.files[0];

            // Get audio duration
            const audio = new Audio();
            const objectUrl = URL.createObjectURL(file);
            audio.src = objectUrl;

            audio.addEventListener('loadedmetadata', async () => {
                const audioDuration = audio.duration;

                // Start transcription
                const startTime = performance.now();
                showStatus('<span class="spinner"></span> Transcribing audio (this may take a minute)...', 'info');
                document.getElementById('transcribeBtn').disabled = true;

                try {
                    const result = await model(file);
                    const endTime = performance.now();
                    const processingTime = (endTime - startTime) / 1000;

                    const transcribedText = result.text;
                    const scriptText = scriptInput.value.trim();

                    // Calculate scores
                    const similarity = stringSimilarity(
                        transcribedText.toLowerCase(),
                        scriptText.toLowerCase()
                    );
                    const wordAccuracy = scriptText ? calculateWordAccuracy(transcribedText, scriptText) : null;

                    // Display results
                    document.getElementById('resultsCard').style.display = 'block';
                    document.getElementById('stringSimilarity').textContent = similarity.toFixed(1);
                    document.getElementById('wordAccuracy').textContent = wordAccuracy ? wordAccuracy.toFixed(1) : 'N/A';
                    document.getElementById('processingTime').textContent = processingTime.toFixed(2);
                    document.getElementById('audioDuration').textContent = audioDuration.toFixed(2);
                    document.getElementById('transcribedText').textContent = transcribedText;
                    document.getElementById('referenceText').textContent = scriptText || '(No reference script provided)';

                    // Display score badge
                    let badge = '';
                    if (similarity >= 90) {
                        badge = '<span class="score-badge score-pass">‚úì PASS (‚â•90%)</span>';
                    } else if (similarity >= 80) {
                        badge = '<span class="score-badge score-warning">‚ö† WARNING (80-90%)</span>';
                    } else {
                        badge = '<span class="score-badge score-fail">‚úó FAIL (<80%)</span>';
                    }
                    document.getElementById('scoreDisplay').innerHTML = badge;

                    showStatus(
                        `‚úì Transcription complete<br/>` +
                        `Processing time: ${processingTime.toFixed(2)}s<br/>` +
                        `Audio duration: ${audioDuration.toFixed(2)}s<br/>` +
                        `Processing speed: ${(audioDuration / processingTime).toFixed(2)}x (higher is faster)`,
                        'success'
                    );
                } catch (error) {
                    showStatus(`Error during transcription: ${error.message}`, 'error');
                    console.error('Transcription error:', error);
                } finally {
                    document.getElementById('transcribeBtn').disabled = false;
                    URL.revokeObjectURL(objectUrl);
                }
            });
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Clear results
        function clearResults() {
            document.getElementById('audioInput').value = '';
            document.getElementById('scriptInput').value = '';
            document.getElementById('fileInfo').textContent = 'No file selected';
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('statusArea').innerHTML = '';
        }

        // Load sample script
        function loadSampleScript() {
            document.getElementById('scriptInput').value = `The quick brown fox jumps over the lazy dog.
This is a sample transcription test.
Please ensure the audio matches this script as closely as possible.`;
        }
    </script>
</body>
</html>
